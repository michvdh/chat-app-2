import Head from "next/head";
import Image from "next/image";
import { Inter } from "@next/font/google";
import SideNav from "@/components/SideNav";
import ContactList from "@/components/ContactList";
import ChatMain from "@/components/main/ChatMain";
import ChatMainHeader from "@/components/main/ChatMainHeader";
import React, { useState, useEffect, Fragment } from "react";
import axios from "axios";
import { useRouter } from "next/router";
import { allUsersRoute } from "./api/APIRoutes";
import Welcome from "@/components/main/Welcome";

const inter = Inter({ subsets: ["latin"] });

export default function Home() {
  // This is the Chat Page where user is currently logged in

  const router = useRouter();
  const [contacts, setContacts] = useState([]);

  const [currentUser, setCurrentUser] = useState(undefined); 
    // this is your account

  const [currentChat, setCurrentChat] = useState(undefined);
    // this is the person you're chatting

  const [isLoaded, setIsLoaded] = useState(false);

  const changeChatHandler = (chat) => {
    setCurrentChat(chat);
  };

  useEffect(() => {
    const accessLocalStorage = async () => {
      if (!localStorage.getItem("chat-app-user")) {
        router.push("/login");
      } else {
        setCurrentUser(await JSON.parse(localStorage.getItem("chat-app-user")));
      }
    };

    accessLocalStorage();
  }, []);

  useEffect(() => {
    const getContacts = async () => {
      if (currentUser) {
        const data = await axios.get(`${allUsersRoute}/${currentUser._id}`);
        setContacts(data.data);
      }
    };

    getContacts();
    setIsLoaded(true);
  }, [currentUser]);

  return (
    <>
      <Head>
        <title>ASG Chat App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>
        <SideNav />
        <ContactList
          contacts={contacts}
          currentUser={currentUser}
          changeChat={changeChatHandler}
        />
        <div className="chat--main">
          <ChatMainHeader currentChat={isLoaded && currentChat ? currentChat.username : ''}/>

          {isLoaded && currentChat === undefined ? 
            <Welcome currentUser={currentUser} />
            :
            <Fragment>
              <ChatMain 
                currentUser={currentUser} 
                currentChat={currentChat}
              />
            </Fragment> 
          }
          
        </div>
      </main>
    </>
  );
}
